<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KotakChat ‚Äî Animated Login Edition</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    :root{
      --bg-1:#0b1220; --bg-2:#0f1724; --panel:#0f1726; --accent:#5b8bff;
      --muted:#9aa6b2; --me-bg:#1b2a44; --you-bg:#111827; --shadow: 0 8px 30px rgba(2,6,23,0.6);
      --sidebar-w:320px; --danger:#ff4d4d;
    }
    html,body{height:100%;margin:0;font-family:Inter,sans-serif;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));color:#e6eef8;overflow:hidden}
    
    /* Kontejner aplikace - skryt√Ω do p≈ôihl√°≈°en√≠ */
    .app{height:100vh;display:none;gap:18px;padding:18px;box-sizing:border-box}

    /* Animace sidebaru zleva */
    .sidebar{
      width:var(--sidebar-w);min-width:240px;display:flex;flex-direction:column;gap:12px;position:relative;
      animation: slideInLeft 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }

    /* Animace chatu zprava */
    .panel{
      flex:1;display:flex;flex-direction:column;background:rgba(15,23,38,0.5);border-radius:14px;
      border:1px solid rgba(255,255,255,0.03);overflow:hidden;position:relative;z-index:100;
      animation: slideInRight 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards;
    }

    @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

    /* Brand & Menu */
    .brand{display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;cursor:pointer;position:relative;z-index:2147483647 !important;background:rgba(255,255,255,0.02);transition:background 0.2s}
    .brand:hover{background:rgba(255,255,255,0.05)}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#6fb7ff);display:flex;align-items:center;justify-content:center;color:#071228;font-weight:800}
    
    .acc-menu{
      position:absolute; top:75px; left:0; width:100%; background:var(--panel); border:1px solid rgba(255,255,255,0.05); border-radius:12px; box-shadow:var(--shadow); display:none; flex-direction:column; overflow:hidden; z-index:2147483646;
    }
    .acc-menu.show{display:flex; animation: slideDown 0.2s ease-out;}
    @keyframes slideDown { from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)} }
    .acc-item{padding:12px 16px; font-size:14px; color:var(--muted); cursor:pointer; background:transparent; border:0; text-align:left; transition: 0.2s; width:100%}
    .acc-item:hover{background:rgba(255,255,255,0.03); color:#fff}
    .acc-item.danger{color:var(--danger)}

    /* Block Panel */
    #blockPanel {
      position: fixed; bottom: -500px; right: 20px; width: 300px; height: 400px; background: var(--panel); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px 16px 0 0; box-shadow: var(--shadow); z-index: 2000; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column;
    }
    #blockPanel.show { bottom: 0; }
    .block-header { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-weight: bold; display: flex; justify-content: space-between; }
    .block-list { flex: 1; overflow-y: auto; padding: 10px; }

    /* UI Common */
    .search{padding:10px 12px;background:rgba(255,255,255,0.02);border-radius:12px;display:flex;gap:8px}
    .search input{border:0;outline:none;width:100%;color:#fff;background:transparent;font-size:14px}
    .chats{flex:1;overflow-y:auto;padding-right:4px}
    .chatItem{display:flex;align-items:center;gap:14px;padding:12px;border-radius:12px;cursor:pointer;margin-bottom:4px;position:relative;transition:0.2s}
    .chatItem:hover{background:rgba(255,255,255,0.04)}
    .chatItem.active{background:rgba(91,139,255,0.1)}
    .avatar-wrapper{position:relative; width:40px; height:40px; flex-shrink:0;}
    .avatar{width:100%; height:100%; border-radius:10px; background:#2b3b58; display:flex; align-items:center; justify-content:center; font-weight:bold}
    .status-dot{width:12px; height:12px; border-radius:50%; position:absolute; bottom:-2px; right:-2px; border:2.5px solid var(--bg-1);}
    .status-online{background:#4ade80}
    .status-offline{background:#94a3b8}
    .user-info{display:flex; flex-direction:column; gap:2px; overflow:hidden}
    .user-info strong{font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .user-info small{font-size:12px; color:var(--muted)}
    .block-marker { font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; width: 30px; height: 30px; }

    /* Messages */
    .header{padding:15px;border-bottom:1px solid rgba(255,255,255,0.05);font-weight:bold;display:flex;justify-content:space-between}
    .messages{flex:1;padding:22px;overflow-y:auto;display:flex;flex-direction:column;gap:10px}
    .msg{display:flex;flex-direction:column; width: 100%;}
    .msg.me{align-items:flex-end}
    .bubble{max-width: 65%; width: fit-content; min-width: 30px; border-radius: 14px; background: var(--you-bg); font-size: 14px; overflow: hidden; word-break: break-word; white-space: pre-wrap; display: flex; flex-direction: column;}
    .bubble.me{background:var(--me-bg)}
    .bubble img{display:block; width:100%; height:auto; cursor:pointer;}
    .bubble-text{padding: 10px 14px; line-height: 1.4;}

    /* Input Area */
    .inputRow{padding:12px;display:flex;gap:10px;background:rgba(0,0,0,0.2); align-items: center;}
    .fileBtn{background:rgba(255,255,255,0.05); border:0; width:44px; height:44px; border-radius:10px; cursor:pointer; font-size:20px; display:flex; align-items:center; justify-content:center;}
    .compose{flex:1;background:rgba(255,255,255,0.02);border-radius:10px;padding:8px}
    .compose textarea{width:100%;background:transparent;border:0;color:#fff;outline:none;height:40px;resize:none;font-family:inherit}
    .sendBtn{background:var(--accent);border:0;padding:10px 16px;border-radius:10px;font-weight:bold;cursor:pointer;color:#071228; height:44px;}
    .sendBtn:disabled { background: #333 !important; color: #666 !important; }

    #lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:2147483647;cursor:zoom-out}
    #lightbox img{max-width:95%; max-height:95%; border-radius:5px;}

    /* Auth Overlay */
    #authOverlay{position:fixed;inset:0;background:var(--bg-1);display:flex;align-items:center;justify-content:center;z-index:99999}
    .authBox{width:360px;background:var(--panel);padding:24px;border-radius:16px;box-shadow:var(--shadow)}
    .authBox input{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:1px solid #333;background:#000;color:#fff;box-sizing:border-box}
    .authTabs{display:flex;gap:8px;margin-bottom:15px}
    .authTabs button{flex:1;padding:10px;background:rgba(255,255,255,0.05);color:#fff;border-radius:8px;cursor:pointer;border:0}
    .authTabs button.active{background:var(--accent);color:#000;font-weight:bold}
  </style>
</head>
<body>

<div id="authOverlay">
  <div class="authBox">
    <h2 style="text-align:center;margin-top:0">KotakChat</h2>
    <div class="authTabs">
      <button id="tabL" class="active">P≈ôihl√°sit</button>
      <button id="tabR">Registrovat</button>
    </div>
    <div id="formL">
      <input type="email" id="emailL" placeholder="Email">
      <button onclick="doLogin()" style="width:100%;padding:14px;background:var(--accent);border:0;border-radius:8px;font-weight:bold;margin-top:10px;cursor:pointer;color:#000">Vstoupit</button>
    </div>
    <div id="formR" style="display:none">
      <input type="text" id="nameR" placeholder="Jm√©no">
      <input type="email" id="emailR" placeholder="Email">
      <button onclick="doReg()" style="width:100%;padding:14px;background:var(--accent);border:0;border-radius:8px;font-weight:bold;margin-top:10px;cursor:pointer;color:#000">Vytvo≈ôit √∫ƒçet</button>
    </div>
  </div>
</div>

<div id="blockPanel" onclick="event.stopPropagation()">
    <div class="block-header"><span>Spr√°va blokov√°n√≠</span><span onclick="toggleBlockPanel()" style="cursor:pointer">‚úï</span></div>
    <div class="search" style="margin:10px"><input type="text" id="bSearch" placeholder="Hledat nebo vidƒõt blokovan√©..."></div>
    <div id="bList" class="block-list"></div>
</div>

<div id="lightbox" onclick="this.style.display='none'"><img id="lbImg" src=""></div>

<div class="app" id="mainApp">
  <aside class="sidebar">
    <div class="brand" id="brandBtn">
      <div class="logo">K</div>
      <div><h2 id="myNm" style="margin:0;font-size:16px">Host</h2><div id="myId" style="font-size:11px;color:var(--muted)">#-----</div></div>
    </div>
    <div class="acc-menu" id="accMenu" onclick="event.stopPropagation()">
        <button class="acc-item" onclick="logout()">üö™ Odhl√°sit se</button>
        <button class="acc-item" id="blockBtn" onclick="toggleBlockPanel(); event.stopPropagation();">üö´ Zablokovat</button>
        <button class="acc-item danger" onclick="logout()">üóëÔ∏è Smazat √∫ƒçet</button>
    </div>
    <div class="search"><input type="text" id="uSearch" placeholder="Hledat jm√©no nebo email..."></div>
    <div id="uList" class="chats"></div>
  </aside>

  <main class="panel">
    <div class="header"><div id="chatTitle">Vyberte chat</div><div id="activeId" style="font-size:12px;color:var(--muted)"></div></div>
    <div class="messages" id="msgBox"></div>
    <div class="inputRow">
      <input type="file" id="imgInput" accept="image/*" style="display:none">
      <button class="fileBtn" onclick="document.getElementById('imgInput').click()">üìé</button>
      <div class="compose"><textarea id="composer" placeholder="Napi≈°te zpr√°vu..."></textarea></div>
      <button id="sendBtn" class="sendBtn">Odeslat</button>
    </div>
  </main>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBqoI6ix48hfBHGPKwFNLCkhtpijasvQ08",
    authDomain: "kotakengine-chat.firebaseapp.com",
    databaseURL: "https://kotakengine-chat-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "kotakengine-chat",
    storageBucket: "kotakengine-chat.firebasestorage.app",
    messagingSenderId: "669139296004",
    appId: "1:669139296004:web:e5d26b33c8e2bd4a6dfa51"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  let currentUser = JSON.parse(localStorage.getItem('ke_user'));
  let activeChatId = null;
  let activeOtherId = null;
  let searching = false;
  let blockedByMe = {}; 
  let iAmBlockedByOther = false; 

  const tL=document.getElementById('tabL'), tR=document.getElementById('tabR'), fL=document.getElementById('formL'), fR=document.getElementById('formR');
  tL.onclick=()=>{fL.style.display='block';fR.style.display='none';tL.className='active';tR.className='';}
  tR.onclick=()=>{fR.style.display='block';fL.style.display='none';tR.className='active';tL.className='';}

  if(currentUser) { 
    document.getElementById('authOverlay').style.display='none'; 
    document.getElementById('mainApp').style.display='flex';
    init(); 
  }

  async function doReg() {
    const name=document.getElementById('nameR').value.trim(), email=document.getElementById('emailR').value.trim().toLowerCase();
    if(!name || !email) return alert('Vypl≈àte v≈°e');
    const emailKey = email.replace(/[^a-z0-9]/g, '_');
    const check = await db.ref('email_to_id/' + emailKey).once('value');
    if(check.exists()) return alert('Email u≈æ existuje');
    const newId = Math.floor(10000 + Math.random() * 90000).toString();
    const userObj = { name, email, id: newId, status: 'online' };
    await db.ref('users/' + newId).set(userObj);
    await db.ref('email_to_id/' + emailKey).set(newId);
    localStorage.setItem('ke_user', JSON.stringify(userObj));
    location.reload();
  }

  async function doLogin() {
    const email = document.getElementById('emailL').value.trim().toLowerCase();
    const emailKey = email.replace(/[^a-z0-9]/g, '_');
    const idSnap = await db.ref('email_to_id/' + emailKey).once('value');
    if(idSnap.exists()) {
      const uSnap = await db.ref('users/' + idSnap.val()).once('value');
      localStorage.setItem('ke_user', JSON.stringify(uSnap.val()));
      location.reload();
    } else alert('U≈æivatel nenalezen');
  }

  function toggleBlockPanel() {
    const panel = document.getElementById('blockPanel');
    document.getElementById('accMenu').classList.remove('show');
    panel.classList.toggle('show');
    if(panel.classList.contains('show')) {
      document.getElementById('bSearch').value = '';
      loadInitialBlockedList();
    }
  }

  async function loadInitialBlockedList() {
    const list = document.getElementById('bList'); list.innerHTML = '';
    const blockedIds = Object.keys(blockedByMe);
    if(blockedIds.length === 0) { list.innerHTML = '<div style="font-size:12px;color:var(--muted);text-align:center;padding:10px">≈Ω√°dn√≠ zablokovan√≠.</div>'; return; }
    for (let id of blockedIds) {
      const snap = await db.ref('users/' + id).once('value');
      if(snap.exists()) renderBlockItem(snap.val(), list);
    }
  }

  async function toggleBlock(otherId) {
    const isBlocked = blockedByMe[otherId];
    if(isBlocked) await db.ref(`users/${currentUser.id}/blocked/${otherId}`).remove();
    else await db.ref(`users/${currentUser.id}/blocked/${otherId}`).set(true);
    const searchVal = document.getElementById('bSearch').value;
    if(searchVal.length >= 2) searchUsers(searchVal, 'bList', true); else loadInitialBlockedList();
  }

  function logout() { if(currentUser) db.ref('users/'+currentUser.id+'/status').set('offline'); localStorage.removeItem('ke_user'); location.reload(); }

  window.onclick = (e) => {
    if(!document.getElementById('brandBtn').contains(e.target)) document.getElementById('accMenu').classList.remove('show');
    if(!document.getElementById('blockPanel').contains(e.target) && e.target.id !== 'blockBtn') document.getElementById('blockPanel').classList.remove('show');
  };

  function init() {
    document.getElementById('myNm').textContent = currentUser.name;
    document.getElementById('myId').textContent = "#" + currentUser.id;
    db.ref(`users/${currentUser.id}/blocked`).on('value', snap => { blockedByMe = snap.val() || {}; checkCurrentBlockStatus(); });
    const statusRef = db.ref('users/' + currentUser.id + '/status');
    db.ref('.info/connected').on('value', snap => { if (snap.val()) { statusRef.onDisconnect().set('offline'); statusRef.set('online'); } });
    db.ref('chats').on('value', () => { if (!searching) loadRecentChats(); });
    document.getElementById('uSearch').addEventListener('input', (e) => searchUsers(e.target.value, 'uList'));
    document.getElementById('bSearch').addEventListener('input', (e) => {
      if(e.target.value.length < 2) loadInitialBlockedList(); else searchUsers(e.target.value, 'bList', true);
    });
    document.getElementById('brandBtn').onclick = (e) => { e.stopPropagation(); document.getElementById('accMenu').classList.toggle('show'); };
  }

  async function searchUsers(term, containerId, isBlockPanel = false) {
    term = term.toLowerCase().trim();
    if(term.length < 2) { if(!isBlockPanel) { searching = false; loadRecentChats(); } return; }
    if(!isBlockPanel) searching = true;
    const snap = await db.ref('users').once('value');
    const list = document.getElementById(containerId); list.innerHTML = '';
    snap.forEach(child => {
      const u = child.val();
      if(u.id !== currentUser.id && (u.name.toLowerCase().includes(term) || u.email.includes(term))) {
          if(isBlockPanel) renderBlockItem(u, list); else renderUserItem(u, list);
      }
    });
  }

  function renderUserItem(u, container) {
    const div = document.createElement('div');
    div.className = 'chatItem' + (activeOtherId === u.id ? ' active' : '');
    div.innerHTML = `<div class="avatar-wrapper"><div class="avatar">${u.name[0]}</div><div class="status-dot status-${u.status || 'offline'}" id="dot-${u.id}"></div></div>
                     <div class="user-info"><strong>${u.name}</strong><small>#${u.id}</small></div>`;
    div.onclick = () => startChat(u);
    container.appendChild(div);
  }

  function renderBlockItem(u, container) {
    const isBlocked = blockedByMe[u.id];
    const div = document.createElement('div');
    div.className = 'chatItem'; div.style.cursor = 'default';
    div.innerHTML = `<div class="block-marker" onclick="toggleBlock('${u.id}')" style="cursor:pointer">${isBlocked ? 'üî∫' : '‚ö™'}</div>
      <div class="avatar" style="width:30px;height:30px;font-size:12px;border-radius:6px;margin:0 10px">${u.name[0]}</div>
      <div class="user-info"><strong>${u.name}</strong></div>`;
    container.appendChild(div);
  }

  function checkCurrentBlockStatus() {
    const composer = document.getElementById('composer'), sendBtn = document.getElementById('sendBtn');
    if(!activeOtherId) return;
    if(blockedByMe[activeOtherId] || iAmBlockedByOther) {
        composer.disabled = true; composer.value = ""; composer.placeholder = "Zablokov√°no"; sendBtn.disabled = true;
    } else {
        composer.disabled = false; composer.placeholder = "Napi≈°te zpr√°vu..."; sendBtn.disabled = false;
    }
  }

  function loadRecentChats() {
    const list = document.getElementById('uList');
    db.ref('chats').once('value', snap => {
      if (searching) return;
      list.innerHTML = '';
      snap.forEach(chatDoc => {
        if (chatDoc.key.includes(currentUser.id)) {
          const otherId = chatDoc.key.split('_vs_').find(id => id !== currentUser.id);
          if (otherId) db.ref('users/' + otherId).once('value', uSnap => { if (uSnap.exists()) renderUserItem(uSnap.val(), list); });
        }
      });
    });
  }

  function startChat(other) {
    activeOtherId = other.id; activeChatId = [currentUser.id, other.id].sort().join('_vs_');
    document.getElementById('chatTitle').textContent = other.name;
    document.getElementById('activeId').textContent = "";
    db.ref(`users/${other.id}/blocked/${currentUser.id}`).on('value', snap => { iAmBlockedByOther = snap.exists(); checkCurrentBlockStatus(); });
    const chatRef = db.ref('chats/' + activeChatId); chatRef.off();
    chatRef.on('value', snap => {
      const box = document.getElementById('msgBox'); box.innerHTML = '';
      snap.forEach(child => {
        const m = child.val(), me = m.s === currentUser.id;
        const div = document.createElement('div'); div.className = `msg ${me ? 'me' : 'you'}`;
        let content = m.img ? `<img src="${m.img}" onclick="showImg(this.src)">` : "";
        if(m.t) content += `<div class="bubble-text">${m.t}</div>`;
        div.innerHTML = `<div class="bubble ${me ? 'me' : ''}">${content}</div>`;
        box.appendChild(div);
      });
      box.scrollTop = box.scrollHeight;
    });
  }

  async function send(text = null, imgData = null) {
    if(!activeChatId || blockedByMe[activeOtherId] || iAmBlockedByOther) return;
    const t = text !== null ? text : document.getElementById('composer').value.trim();
    if(!t && !imgData) return;
    document.getElementById('composer').value = '';
    await db.ref('chats/' + activeChatId).push({ t: t || "", s: currentUser.id, img: imgData || null });
  }

  document.getElementById('imgInput').onchange = function(e) {
    const file = e.target.files[0]; if(!file) return;
    const reader = new FileReader();
    reader.onload = function(ev) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height; if(w > 800) { h *= 800/w; w = 800; }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0,0, w, h);
            send("", canvas.toDataURL('image/jpeg', 0.6));
        };
        img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
    this.value = "";
  };

  function showImg(src) { document.getElementById('lbImg').src = src; document.getElementById('lightbox').style.display = 'flex'; }
  document.getElementById('sendBtn').onclick = () => send();
  document.getElementById('composer').onkeydown = (e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } };
</script>
</body>
</html>